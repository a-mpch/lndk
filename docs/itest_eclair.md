# Running Eclair Integration Tests

These tests verify LNDK's ability to interact with an Eclair node, specifically paying BOLT 12 offers generated by Eclair.

## Prerequisites

1.  **Docker and Docker Compose:** Ensure Docker and Docker Compose are installed on your system.
2.  **Rust Toolchain:** Have a working Rust development environment.
3.  **LND Binary:** The tests require an `lnd` binary compiled with necessary RPC subservers (like `walletrpc`, `chainrpc`, `invoicesrpc`, `routerrpc`, etc.) and experimental features enabled (`--protocol.custom-message=513`, `--protocol.custom-nodeann=39`, `--protocol.custom-init=39`). Follow LND compilation instructions if needed. The test common code expects this binary at `/tmp/lndk-tests/bin/lnd-itest`.
```

## Setup

1.  **Start Eclair Container:**
    Run the Eclair docker-compose setup:
    ```bash
    docker compose -f itest-docker/docker-compose-eclair.yaml up -d --wait
    ```
    This command starts `bitcoind` and `eclair` containers in the background.

2.  **Compile LND (if needed):** Ensure the `lnd-itest` binary exists in the expected location (`/tmp/lndk-tests/bin/`). If not, run makefile to compile the binary:
    ```bash
    make build-lnd
    ```

## Running the Tests

Execute the tests from the project root directory using the following command:

```bash
RUSTFLAGS="--cfg eclair_test" cargo test --test integration_tests_eclair -- --test-threads=1 --nocapture
```

*   `RUSTFLAGS="--cfg eclair_test"`: Enables the Eclair-specific tests via the conditional compilation flag.
*   `cargo test --test integration_tests_eclair`: Specifies the test file to run.
*   `--test-threads=1`: Recommended for integration tests involving network setup to avoid port conflicts and race conditions.
*   `--nocapture`: Prevents the test output from being captured in the terminal.

## Teardown

After running the tests, stop the Docker containers:

```bash
cd docker
docker compose -f itest-docker/docker-compose-eclair.yaml down --volumes
```

This cleans up the `bitcoind` and `eclair` containers. Test data directories under `/tmp/lndk-tests/` will persist unless manually deleted.

### Local development on itest-eclair

#### MacOS

Running integration test on MacOS requires a few extra steps:

1. Build Eclair from source and tag the image `docker build --platform linux/arm64 -t eclair:arm64 .`
1. Change the image and remove the platform in `docker-compose-itest-eclair.yaml`